# c200 Tapo cam

## Port analysis

    $ nmap -sV -p- 192.168.0.161
        Nmap scan report for C200_F81AB2.home (192.168.1.81)
        Host is up (0.022s latency).
        Not shown: 996 closed ports
        PORT     STATE SERVICE
        443/tcp  open  https
        554/tcp  open  rtsp
        2020/tcp open  xinupageserver
        8800/tcp open  sunwebadmin

*   No atual web pages in none of the ports.

## Get shell with UART

1. Connect the USB to UART
2. `$ sudo screen /dev/ttyUSB0 57600` for Linux and `$ sudo screen /dev/tty.usbserial-0001 57600` for MacOS (57600 is the baud rate of the camera). Log file can be produced with -L (screenlog.0)
3. Turn the  camera on
4. Once the camera is up and running, press enter and login as root with default credentials `root:slprealtek`

        root@SLP:~# uname -a
            Linux SLP 3.10.27 #1 PREEMPT Wed Nov 11 20:42:05 CST 2020 rlx GNU/Linux

        root@SLP:~# cat /etc/openwrt_release
            DISTRIB_ID="OpenWrt"
            DISTRIB_RELEASE="Attitude Adjustment"
            DISTRIB_REVISION="3f6632193f1421becd417d82f5e825ae759413e5"
            DISTRIB_CODENAME="attitude_adjustment"
            DISTRIB_TARGET="realtek/generic"
            DISTRIB_DESCRIPTION="OpenWrt Attitude Adjustment 12.09-rc1"

        root@SLP:~# cat /etc/openwrt_version
            12.09-rc1

        root@SLP:~# netstat -natpu
            Active Internet connections (servers and established)
            Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
            tcp        0      0 0.0.0.0:8800            0.0.0.0:*               LISTEN      920/cet
            tcp        0      0 127.0.0.1:929           0.0.0.0:*               LISTEN      875/p2pd
            tcp        0      0 0.0.0.0:20002           0.0.0.0:*               LISTEN      325/tp_manage
            tcp        0      0 0.0.0.0:2020            0.0.0.0:*               LISTEN      969/nvid
            tcp        0      0 0.0.0.0:554             0.0.0.0:*               LISTEN      920/cet
            tcp        0      0 127.0.0.1:23            0.0.0.0:*               LISTEN      832/telnetd
            tcp        0      0 127.0.0.1:921           0.0.0.0:*               LISTEN      878/relayd
            tcp        0      0 127.0.0.1:922           0.0.0.0:*               LISTEN      877/rtspd
            tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      863/uhttpd
            tcp        0      0 192.168.1.80:37380      52.19.66.90:443         ESTABLISHED 507/cloud-brd
            udp        0      0 0.0.0.0:20002           0.0.0.0:*                           325/tp_manage
            udp        0      0 0.0.0.0:38000           0.0.0.0:*                           1087/ntpd
            udp        0      0 0.0.0.0:3702            0.0.0.0:*                           969/nvid

        root@SLP:~# ps
            PID USER       VSZ STAT COMMAND
            1 root      2328 S    init
            2 root         0 SW   [kthreadd]
            3 root         0 SW   [ksoftirqd/0]
            4 root         0 SW   [kworker/0:0]
            5 root         0 SW<  [kworker/0:0H]
            6 root         0 SW   [kworker/u2:0]
            7 root         0 SW   [rcu_preempt]
            8 root         0 SW   [rcu_bh]
            9 root         0 SW   [rcu_sched]
            10 root         0 SW<  [khelper]
            11 root         0 SW<  [writeback]
            12 root         0 SW<  [bioset]
            13 root         0 SW<  [kblockd]
            14 root         0 SW   [khubd]
            15 root         0 SW   [kworker/0:1]
            16 root         0 SW   [kswapd0]
            17 root         0 SW   [fsnotify_mark]
            18 root         0 SW<  [crypto]
            27 root         0 SW   [kworker/u2:1]
            46 root         0 SW<  [deferwq]
            47 root         0 SW<  [kworker/0:1H]
            247 root      2328 S    -ash
            262 root         0 SW   [irq/27-gpio res]
            273 root         0 SW<  [cryptodev_queue]
            282 root       860 S    /sbin/hotplug2 --override --persistent --set-rules-f
            304 root       888 S    /sbin/ubusd
            325 root      8152 S    tp_manage
            357 root      3416 S    /usr/bin/ledd
            361 root      3408 S    /sbin/msglogd
            367 root      3220 S    /usr/sbin/netlinkd
            370 root      5468 S <  /usr/bin/system_state_audio
            379 root     10180 S    /usr/sbin/wlan-manager
            491 root      1636 S    /sbin/netifd
            492 root      1520 S    /usr/sbin/connModed
            494 root     11488 S    /usr/bin/dsd
            496 root      1532 S    /usr/sbin/connModed
            502 root      7640 S    /bin/cloud-service
            520 root      4360 S    /bin/cloud-brd -c /var/etc/cloud_brd_conf
            653 root     15020 S    /bin/cloud-client
            830 root      2320 S    /usr/sbin/telnetd -b 127.0.0.1
            861 root      3852 S    /usr/sbin/uhttpd -f -h /www -T 180 -A 0 -n 8 -R -r C
            870 root      6048 S    /usr/bin/relayd
            872 root      5948 S    /usr/bin/rtspd
            879 root      4612 S    /usr/bin/p2pd
            884 root     11152 S    /bin/dn_switch
            889 root      4180 S    /bin/storage_manager
            920 root     40940 S    /bin/cet
            956 root     32336 S    /bin/vda
            960 root      3808 S    /bin/wtd
            970 root     11288 S    /bin/nvid
            1019 root      2332 S    udhcpc -p /var/run/static-dhcpc.pid -s /lib/netifd/s
            1037 root         0 SW   [RTW_CMD_THREAD]
            1059 root      1212 S    wpa_supplicant -B -Dwext -iwlan0 -P/tmp/supplicant_p
            1089 root      2332 S    /usr/sbin/ntpd -n -p time.nist.gov -p 133.100.9.2 -p
            1103 root      3840 S    /usr/bin/motord
            1447 root      2324 R    ps

        root@SLP:~# uci show | grep user
            OSD_capability.font_info.color_type=auto user_defined
            cloud_config.bind.username=hqMcgS4U/bkcM8QZQHT34NGANTSXH7XUV4OlbQeto5s=
            function.module_spec.multi_user=0
            luci.flash_keep.firewall=/etc/firewall/firewall.user
            user_management.root=root
            user_management.root.username=admin
            user_management.root.passwd=874AAEB45AF77D9E0E0A17619C640F60
            user_management.root.ciphertext=CHQTKowKXiEs2HKDRLmvbnFfGik/32xUU/a1LQjOV/cWvTStuHKtEqotDDg3KmvxF4rXeb4tibsyPfAR/2WRibpBm7g8QJjmewkljbMFFJ16B+7o88593eRmqkmgY0+EElGrsWBZoKLWfypF2Cyc8SIOFRVjZ76McS/LPqwn5So=
            user_management.root.sharepwd=1604d5590be8e9336f73d641f6da0485
            user_management.third_account=third_account
            user_management.third_account.username=---
            user_management.third_account.passwd=---
            user_management.third_account.ciphertext=dl5GoIRk+FMC/JgP5yLjA+r8PynYYSai8DSmdv1Xw7iALNEKxkE5UusQw6BMC4+FlcWv0bCPuw8DSlSk/vkmcTZ/BF/ZY1ENNJqo+uJtiGi2f1zJFjleYhPlDx4YXa3qp7oSNF8EU1BU4mOY9nEtUakFl4oVPsvlLGM3qE/zI2k=
            user_management.authentication=authentication
            user_management.authentication.basic_enabled=0

## Firmware analysis

*   Found firmware of the camera on GitHub issue about it (https://github.com/nervous-inhuman/tplink-tapo-c200-re/issues/1).
*   Once downloaded, firmware is inside /firmware-c100/squashfs-root.
*   Opening binaries in Ghidra, language is MIPS32, little endian, with mips16e
*   Defined custom empty structs `uci_context` and `uci_ptr` (referencing structs in `libuci.so`) and edited functions from `libuci.so` to match these types.

## Exploiting uhttpd

*   `http://<camera_ip>:443` gives us `400 Bad Request`.
*   `https://<camera_ip>` gives us `NET::ERR_CERT_INVALID` in the browser, however `$ curl -k https://192.168.1.80` responds with `No such file or directory`

### Process info

    Usage: %s -p [addr:]port [-h docroot]
        -f              Do not fork to background
        -c file         Configuration file, default is \'/etc/httpd.conf\'
        -p [addr:]port  Bind to specifiedaddress and port, multiple allowed
        -s [addr:]port  Like -p but provide HTTPS on thisport
        -C file         ASN.1 server certificate file
        -K file         ASN.1 server privatekey file
        -h directory    Specify the document root, default is \'.\'
        -E string       Usegiven virtual URL as 404 error handler
        -I string       Use given filename as index fordirectories, multiple allowed
        -S              Do not follow symbolic links outside of thedocroot
        -D              Do not allow directory listings, send 403 instead
        -R              Enable RFC1918 filter
        -n count        Maximum allowed number of concurrent requests
        -T seconds       Network timeout in seconds, default is 30
        -d string       URL decode givenstring
        -r string       Specify basic auth realm
        -m string       MD5 crypt givenstring
        -w string       wan device name

    $ ls -l /proc/864/fd/
        lrwx------    1 root     root            64 Nov 10 22:44 0 -> /dev/null
        lrwx------    1 root     root            64 Nov 10 22:44 1 -> /dev/null
        lrwx------    1 root     root            64 Nov 10 22:44 2 -> /dev/null
        lrwx------    1 root     root            64 Nov 10 22:44 3 -> anon_inode:[eventpoll]
        lrwx------    1 root     root            64 Nov 10 22:44 4 -> socket:[1830]

    $ cat /proc/863/environ 
        CONFIG_ntp_def_server_ITEM4=192.36.144.22
        CONFIG_basic_TYPE=setting
        CONFIG_ntp_def_server_ITEM5=time-a.nist.gov
        CONFIG_main_max_requests=8
        CONFIG_main_listen_https=443
        USER=root
        CONFIG_ntp_def_server_ITEM6=time-b.nist.gov
        CONFIG_ntp_def_server_ITEM7=time.windows.com
        https=443
        CONFIG_ntp_def_server_ITEM8=time-nw.nist.gov
        CONFIG_ntp_def_server_ITEM9=au.pool.ntp.org
        http=
        UHTTPD_ARGS=-h /www -T 180 -A 0 -n 8 -R -r C200 -C /tmp/uhttpd.crt -K /tmp/uhttpd.key -s 443
        HOME=/
        CONFIG_sys_is_factory=0
        CONFIG_ntp_def_server_ITEM10=nz.pool.ntp.org
        CONFIG_dst_dst_local_start=5.3.0/02:00:00
        UHTTPD_CERT=/tmp/uhttpd.crt
        CONFIG_basic_timezone=UTC-00:00
        CONFIG_ntp_server=0.0.0.0
        CONFIG_main_home=/www
        CONFIG_dst_dst_start=2021:5:3:1:120
        CONFIG_dst_TYPE=
        dstindexes=
        CONFIG_sys_makeroom_status=0
        UHTTPD_KEY=/tmp/uhttpd.key
        CONFIG_main_cert=/tmp/uhttpd.crt
        CONFIG_sys_diagnose_mode=off
        CONFIG_dst_enalbed=1
        CONFIG_ntp_def_server_LENGTH=
        CONFIG_main_cgi_prefix=/cgi-bin
        TERM=vt102CONFIG_ntp_def_server=
        CONFIG_px5g_location=China
        CONFIG_px5g_state=China
        CONFIG_sys_network_type=WiFi
        CONFIG_ntp_TYPE=timing
        CONFIG_NUM_SECTIONS=2
        PATH=/sbin:/usr/sbin:/bin:/usr/bin
        CONFIG_main_tcp_keepalive=0
        CONFIG_LIST_STATE=
        CONFIG_sys_append_dns=192.168.1.1
        CONFIG_dst_dst_savings=60
        CONFIG_sys_dev_alias=Tapo_Camera_1AB2
        CONFIG_ntp_timing_interval=1440
        CONFIG_dst_dst_offset=DST-01:00
        CONFIG_basic_timing_mode=ntp
        foreground=0
        CONFIG_px5g_days=3600
        CONFIG_main_network_timeout=180
        CONFIG_main_script_timeout=180
        CONFIG_main_TYPE=uhttpd
        CONFIG_dst_synced=1
        CONFIG_px5g_bits=1024
        SHELL=/bin/sh
        CONFIG_sys_hostname=SLP
        CONFIG_px5g_country=CN
        CONFIG_px5g_TYPE=cert
        CONFIG_main_key=/tmp/uhttpd.key
        CONFIG_SECTION=px5g
        CONFIG_dst_dst_local_end=3.5.0/03:00:00
        CONFIG_main_lua_prefix=/
        luciPWD=/
        CONFIG_sys_TYPE=system
        CONFIG_basic_zone_id=Africa/Casablanca
        CONFIG_px5g_commonname=TP-LinkCONFIG_main_rfc1918_filter=1
        CONFIG_main_lua_handler=/usr/lib/lua/luci/sgi/uhttpd.lua
        CONFIG_dst_has_rule=1
        CONFIG_ntp_def_server_ITEM1=time.nist.gov
        interpreter=cfg
        type=uhttpd
        CONFIG_SECTIONS=main px5g
        CONFIG_ntp_def_server_ITEM2=133.100.9.2
        CONFIG_sys_alias=C200 1.0
        CONFIG_ntp_ntp_port=999
        CONFIG_ntp_def_server_ITEM3=128.138.140.44
        CONFIG_dst_dst_end=2022:3:4:1:120

### Binary analysis

*   `exec_and_read_json` lets us execute commands
 
        char * exec_and_read_json(char *command,void *buf,int size){
            FILE *process_stream;
            char *return_value;
            
            if (command == (char *)0x0) {
                return (char *)0x0;
            }
            if (((buf != (void *)0x0) && (0 < size)) && (process_stream = popen(command,"r"), process_stream != (FILE *)0x0)) {
                                /* memset */
                func_0x00411e60(buf,0,size);
                fread(buf,1,size + -1,process_stream);
                pclose(process_stream);
                return_value = jso_from_string();
                return return_value;
            }
            return (char *)0x0;
        }

*   `exec_and_read_json` is used by `set_language` and `wifi_connect`

        void set_language(int *response_struct,char *language_json){
            int iVar1;
            undefined4 language;
            int iVar2;
            undefined auStack1048 [512];
            char acStack536 [512];
            int local_18 [3];
            
            func_0x00411e60(acStack536,0,0x200);
            func_0x00411e60(auStack1048,0,0x200);
            local_18[0] = 0;
            iVar1 = jso_is_obj(language_json);
            if (iVar1 == 0) {
                language = 0xffff62ef;
            }
            else {
                language = json_object_to_json_string(language_json);
                snprintf(acStack536,0x200,"ubus call system_state_audio set_language \'%s\'",language);
                iVar1 = exec_and_read_json(acStack536,auStack1048,0x200);
                if (iVar1 != 0) {
                    iVar2 = func_0x00411dc0(iVar1,"err_code",local_18);
                    if ((iVar2 < 0) || (local_18[0] != 0)) {
                        func_0x004122e0(iVar1);
                    }
                    else {
                        func_0x004122e0(iVar1);
                        iVar1 = func_0x00411e90();
                        if (iVar1 != 0) {
                            jso_add_int(iVar1,"error_code",local_18[0]);
                            iVar2 = json_object_to_json_string(iVar1);
                            slp_http_response_json(response_struct,iVar2);
                            func_0x004122e0(iVar1);
                            return;
                        }
                    }
                }
                language = 0xffff635b;
            }
            slp_http_response_err_code(response_struct,language);
            return;
        }
        
        void wifi_connect(int *response_struct,char *ap_json){
            int iVar1;
            char *ap;
            undefined4 uVar2;
            int iVar3;
            char *pcVar4;
            undefined4 uVar5;
            int iVar6;
            char *pcVar7;
            undefined auStack1056 [512];
            char command [512];
            int local_20 [2];
            
            func_0x00411e60(command,0,0x200);
            func_0x00411e60(auStack1056,0,0x200);
            local_20[0] = 0;
            iVar1 = jso_is_obj(ap_json);
            if ((iVar1 == 0) || (ap = (char *)json_object_to_json_string(ap_json), ap == (char *)0x0)) {
                uVar5 = 0xffff62ef;
                goto LAB_00409898;
            }
            iVar1 = func_0x004124c0(ap);
                                /* Check for ' */
            iVar6 = 0;
            for (iVar3 = 0; iVar3 < iVar1; iVar3 = iVar3 + 1) {
                iVar6 = iVar6 + (uint)(ap[iVar3] == '\'');
            }
            if (iVar6 == 0) {
                snprintf(command,0x200,"ubus call onboarding connectWiFi \'%s\'",ap);
            LAB_0040983c:
                func_0x00411f10("killall ffs");
                iVar1 = exec_and_read_json(command,auStack1056,0x200);
                if (iVar1 != 0) {
                    iVar3 = func_0x00411dc0(iVar1,"err_code",local_20);
                    if ((-1 < iVar3) && (local_20[0] == 0)) {
                        jso_obj_del(iVar1,"err_code");
                        uVar5 = func_0x00411e90();
                        jso_obj_add(uVar5,"connect",iVar1);
                        uVar2 = func_0x00411e90();
                        jso_obj_add(uVar2,"onboarding",uVar5);
                        uVar5 = func_0x00411e90();
                        jso_add_int(uVar5,"error_code",0);
                        jso_obj_add(uVar5,"result",uVar2);
                        iVar1 = json_object_to_json_string(uVar5);
                        slp_http_response_json(response_struct,iVar1);
                        func_0x004122e0(uVar5);
                        return;
                    }
                    func_0x004122e0();
                }
            }
            else {
                iVar6 = iVar1 + iVar6 * 3 + 1;
                iVar3 = malloc(iVar6);
                if (iVar3 != 0) {
                    func_0x00411e60(iVar3,0,iVar6);
                    iVar6 = 0;
                    for (pcVar7 = ap; (int)pcVar7 - (int)ap < iVar1; pcVar7 = pcVar7 + 1) {
                        pcVar4 = (char *)(iVar3 + iVar6);
                        *pcVar4 = *pcVar7;
                        if (*pcVar7 == '\'') {
                            pcVar4[1] = '\\';
                            iVar6 = iVar6 + 4;
                            pcVar4[2] = '\'';
                            pcVar4[3] = '\'';
                        }
                        else {
                        iVar6 = iVar6 + 1;
                        }
                    }
                    snprintf(command,0x200,"ubus call onboarding connectWiFi \'%s\'",iVar3);
                    free(iVar3);
                    goto LAB_0040983c;
                }
            }
            uVar5 = 0xffff635b;
            LAB_00409898:
            slp_http_response_err_code(response_struct,uVar5);
            return;
        }

*   `wifi_connect` seems to escape single quotes, but `set_language` doesn't, so it may allow command injection.
*   These 2 functions are used by `uh_slp_proto_request` which is used in the function that seems to provide functionality to the server `main_server_function`.
