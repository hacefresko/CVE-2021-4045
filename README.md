# TP-Link Tapo c200 Unauthenticated RCE

All current versions of the firmware for TP-Link Tapo c200 IP cameras are affected by an unauthenticated RCE vulnerability, present in the uhttpd binary running by default as root.

## Binary analysis (Ghidra)

Function `exec_and_read_json` lets us execute commands
 
![exec_and_read_json](images/exec_and_get_json.png)

Function `exec_and_read_json` is used by `set_language` and `wifi_connect`. `wifi_connect` seems to parse single quotes (`'`), however, `set_language` doesn't. Since there is no further parsing, we can inject commands.

![wifi_connect](images/wifi_connect.png)
![set_language](images/set_language.png)

These 2 functions are used by `uh_slp_proto_request`. This function manages most of the requests, even if they are not authenticated. When submitting a POST request to `https://<camera_ip>:443/`, sent data is validated with the following code

![main_func_1](images/main_func_1.png)
![main_func_2](images/main_func_2.png)

It checks if the data is a valid JSON object, then if it contains a valid `"method"` entry, and then (was discovered by guessing), if the JSON dict also contains `"params":{...}`.

By submitting `{"method": "setLanguage", "params":{}}` we successfully enter the `set_language` function. Then, it converts the JSON object to string and its inserted directly into `"ubus call system_state_audio set_language \'%s\'"`. If we submit `{"method": "setLanguage", "params": {"payload": "'; touch poc;'"}}`, `ubus call system_state_audio set_language '{"method": "setLanguage", "params": {"payload": "'; touch poc;'"}}'` will be executed, which actually contains 3 commands: `ubus call system_state_audio set_language '{"method": "setLanguage", "params": {"payload": "'`, `touch poc`, and `'"}}'`. The second one gives us full code execution.

Since `uhttpd` runs as `root`, if we send a reverse shell, we gain full control of the camera with root privileges.

## Proof of Concept ([pwnTapo.py](pwnTapo.py))

![poc](images/poc.png)
