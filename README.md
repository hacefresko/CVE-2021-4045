# TP-Link Tapo c200 Unauthenticated RCE

All current versions of the firmware for TP-Link Tapo c200 IP cameras are affected by an unauthenticated RCE vulnerability, present in the uhttpd binary running by default as root.

## Binary analysis (Ghidra)

Function `exec_and_read_json` lets us execute commands
 
![exec_and_read_json](images/exec_and_get_json.png)

Function `exec_and_read_json` is used by `set_language` and `wifi_connect`. `wifi_connect` seems to parse single quotes (`'`), however, `set_language` doesn't. This means that if we can fully control the input for `set_language` function, we can successfully inject our own commands.

![wifi_connect](images/wifi_connect.png)
![set_language](images/set_language.png)

Function `set_language` is used by `uh_slp_proto_request`. This function manages most of the requests, even if they are not authenticated. When submitting a POST request to `https://<camera_ip>:443/`, sent data is validated:

![main_func_1](images/main_func_1.png)
![main_func_2](images/main_func_2.png)

First, it checks if data is a valid JSON object. Then, it gets a string value identified by key `"method"` and a dictionary value identified by `"params"` (at least that is what I think, since function call could not be resolved by Ghidra but seemed to work this way).

So, by submitting `{"method": "setLanguage", "params":{}}` we successfully call `set_language` function and pass `{}` `language_json`. Then, inside `set_language`, `language_json` JSON object is converted to string and inserted directly into `"ubus call system_state_audio set_language \'%s\'"` to be executed. 

By submitting `{"method": "setLanguage", "params": {"payload": "'; touch poc;'"}}`, `ubus call system_state_audio set_language '{"payload": "'; touch poc;'"}'` will be executed, which actually contains 3 commands: `ubus call system_state_audio set_language '{"payload": "'`, `touch poc`, and `'"}'`. The second one gives us full code execution.

As you can see, there is no need for authenticating because `setLanguage` can be called without being logged in. And, since `uhttpd` runs as `root`, if we send a reverse shell, we gain full control of the camera with root privileges without any previous authentication.

## Proof of Concept ([pwnTapo.py](pwnTapo.py))

![poc](images/poc.png)
